# configuration bits for mod_rpmize
# syntax:
# <begin [x]section>
# <end [x]section>
#
# x an be $ for a string or % for a hash.
# if a hash is being used, you can add sub-sections with
# <begin sub-section>
# <end sub-section>


<begin $DESCRIPTION>
%package [LABEL]
Group: System Environment/BlueOnyx
Summary: [LABEL] for [VENDOR]-[SERVICE].
[AUTOFILL]
[BUILDARCH]

%description [LABEL]
The [VENDOR]-[SERVICE]-[LABEL] package contains the [LABEL]
information for [VENDOR]-[SERVICE].

<end $DESCRIPTION>

<begin %PREP>
<end %PREP>

<begin %SETUP>
<end %SETUP>

<begin %BUILD>
<end %BUILD>

<begin %INSTALL>
<end %INSTALL>

<begin %FILES>
<begin HEADER>
%files [LABEL]
%defattr(-,root,root)
<end HEADER>

<begin locale>
[AUTOFILL]

<end locale>

<begin glue>
/etc/suexec.conf
/etc/httpd/conf.d/ssl_perl.conf
/usr/sausalito/sbin/fix_302_httpd_redirects.pl 
/usr/sausalito/sbin/fix_web-and-email-server-aliasses.pl 
/usr/sausalito/sbin/set_default_php_settings.pl
[AUTOFILL]

<end glue>

<begin ui>
[AUTOFILL]

<end ui>

<begin capstone>
%{RootDir}/capstone/%{Vendor}-%{Service}.cap
[AUTOFILL]

<end capstone>
<end %FILES>

<begin %POST-INSTALL>
<begin HEADER>
%post [LABEL]
<end HEADER>

<begin glue>
# glue post-install
if [ -S /usr/sausalito/cced.socket ]; then
    /etc/init.d/cced.init restart
fi

# Make sure that the Apache alias database ownership is setup properly.
if [ -f /etc/httpd/alias/cert8.db ]; then
	/usr/bin/find /etc/httpd/alias -user root -name "*.db" -exec /bin/chgrp apache {} \;
	/usr/bin/find /etc/httpd/alias -user root -name "*.db" -exec /bin/chmod g+r {} \;
fi

if [ $1 = 2 ]; then
  /usr/sausalito/handlers/base/apache/preview.pl -c
fi

# remove server.conf
if [ -f /etc/httpd/conf.d/server.conf ]; then
  /bin/rm -f /etc/httpd/conf.d/server.conf
fi

# While we are at it, delete the default CentOS welcome page:
if [ -f /etc/httpd/conf.d/welcome.conf ]; then
  /bin/rm -f /etc/httpd/conf.d/welcome.conf
fi

# The manual page needs to go as well:
if [ -f /etc/httpd/conf.d/manual.conf ]; then
  /bin/rm -f /etc/httpd/conf.d/manual.conf
fi

# A lot of BX servers have ImageMagick installed, which in turn installs and activates the avahi-daemon.
# This daemon is not really needed and certainly should not be running. Hence we stop it and turn it off:
if [ -f /etc/init.d/avahi-daemon ]; then
        /etc/init.d/avahi-daemon stop >/dev/null 2>&1
        /sbin/chkconfig --level 2345 avahi-daemon off
fi

<end glue>
<begin ui>
# ui post-install

<end ui>
<begin locale>
# locale post-install

<end locale>
<end %POST-INSTALL>

<begin %POST-UNINSTALL>
<begin HEADER>
%postun [LABEL]
<end HEADER>

<begin glue>
# glue post-uninstall

<end glue>
<begin ui>
# ui post-uninstall

<end ui>
<begin locale>
# locale post-uninstall

<end locale>
<end %POST-UNINSTALL>

<begin $CHANGELOG>

* Thu Jun 16 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX16
- Updated glue/handlers/userwebs.pl. The old method affected the sort order of entries in the vhost containers way too much.
  If we want to edit just line in a config file, we can do this in a much simpler fashion.

* Tue Jun 14 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX15
- Updated glue/handlers/virtual_host.pl to make webAliasRedirects configureable.
- For this glue/handlers/virtual_host.pl needed to be made aware of the new switch 'webAliasRedirects' in 'VirtualHosts'
- Additionally glue/schemas/apache.schema got updated with the new 'webAliasRedirects' switch.

* Tue Apr 19 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX14
- Updated constructor/set_httpd_alias_perms.pl to handle the CentOS Apache manual page.

* Mon Apr 18 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX13
- Updated constructor/set_httpd_alias_perms.pl to handle the CentOS welcome page for Apache and to stop and disable the unneeded avahi-daemon if present.

* Sun Apr 10 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX12
- Updated constructor/set_httpd_alias_perms.pl and post install exec of GID and perm fix to handle cases where /etc/httpd/alias/ db's aren't present yet.

* Sun Apr 10 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX11
- Added constructor/set_httpd_alias_perms.pl to automatically fix GID and perms on /etc/httpd/alias/ databases after mod_nss update debacle of CentOS-5.6.
- Added post install execution of permission changes.

* Sun Apr 10 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX10
- Skipped.

* Fri Jan 21 2011 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX09
- Modified ui/extensions/20_USERWEBS.php.create.Vsite, ui/extensions/20_USERWEBS.php.modifyWeb.Vsite and ui/extensions/50_PHP.php.create.Vsite
- When suPHP is enabled, user owned webs are no longer working, as they reside outside the defined DocumentRoot directory.
- There is no work around. So our scripts have been modified to disable user owned webs when suPHP is enabled.
- The English locales have been updated with info regarding this feature change.

* Mon Oct 31 2010 Taco Scargo <taco@scargo.nl> 1.3.0-0BX08
- Modified Apache.conf to fix PHP configuration bug (#295)

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX07
- Updated glue/handlers/webscripting2.pl and glue/handlers/webscripting.pl
- Removed /web from the suPHP path to allow storing files out of sight.
- As we now chown the site directory to the siteAdmin we no longer need to be that restrictive.

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX06
- Extended glue/schemas/vsite_services.schema with 'prefered_siteAdmin' field
- Extended the locales for suPHP with some more explanations.

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX05
- Small cleanup in constructor/fix_php_conf.pl

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX04
- Added constructor/fix_php_conf.pl to set defaults in /etc/httpd/conf.d/php.conf

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX03
- Changed suPHP_AddHandler in web scripting handlers to something more unique

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX02
- Small fixes in web scripting handlers

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.3.0-0BX01
- suPHP support merged in from 5200R as coded by Hisao

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX06
- Merged some 5200R mods over from BlueQuartz - all originally coded by Hisao:
- perl/Httpd.pm: Resolved the issue that the ServerAlias was lost when SSL got enabled.
- glue/handlers/virtual_host.pl: Write SSL configuration to /etc/httpd/conf/vhosts/siteX, do not use mod_perl instead
- Added RewriteCond for webAliases to glue/conf/Apache.conf, glue/handlers/virtual_host.pl and glue/schemas/apache.schema

* Sat Jun 05 2010 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX05
- Copied 'en' locales to 'en_US'

* Mon Oct 15 2009 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX04
- Modified glue/handlers/virtual_host.pl to change vhost redirects from 302 to 301 for better search engine support.
- Added helper scripts sbin/fix_302_httpd_redirects.pl sbin/fix_web-and-email-server-aliasses.pl sbin/set_default_php_settings.pl

* Mon Aug 31 2009 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX03
- Modified glue/httpd/ssl_perl.conf to add Godaddy support through separate ca-chain fine in Vsite certs directory.

* Sat Jun 13 2009 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX02
- Added cced.init restart to post-install in templates/rpmdefs.tmpl

* Fri Jun 12 2009 Michael Stauber <mstauber@solarspeed.net> 1.2.0-0BX01
- Fixed bug in glue/handlers/regen_httpd_figlet which wouldn't update the hostname in our httpd.conf
- Added constructor/set_apache_hostname.pl which updates the hostname in httpd.conf of both Apache and Admserv.
- Added provisions to modify 'AllowOverride' and 'Options' settings in /etc/httpd/conf.d/blueonyx.conf through the GUI.
- The changes for that are as follows:
- Extended glue/schemas/apache.schema with database fields for the new settings.
- Added constructor/import_apache_settings.pl to import existing settings from /etc/httpd/conf.d/blueonyx.conf into CODB.
- Modified ui/web/apache.php with new UI for modifying the settings.
- Modified ui/web/apacheHandler.php to add ability to store the new switches into CODB.
- Added glue/handlers/writeback_blueOnyx_conf.pl to write the new CODB changes to /etc/httpd/conf.d/blueonyx.conf
- Updated glue/conf/Apache.conf with a call to the new handler glue/handlers/writeback_blueOnyx_conf.pl
- Updated locales for new UI lables. English and German locales are complete, rest are a copy of the English version.

* Wed Apr 08 2009 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ38
- Fixed small typo in debugging section of glue/httpd/ssl_perl.conf

* Mon Mar 23 2009 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ37
- Modified ui/web/apacheHandler.php. Array 'error' needed to be pre-declared and wasn't (PHP5 issue).
- Ticket http://devel.blueonyx.it/trac/ticket/54

* Wed Dec 03 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ36
- Rebuilt for BlueOnyx.

* Wed Jun 03 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ35
- USERWEBS set to 0 by default

* Tue Jun 02 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ34
- Changed "Apache::PerlSections()" to "Apache2::PerlSections()" in ssl_perl.conf 

* Thu May 29 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ33
- preview.pl updated to address cases where param->{ipaddr} is empty

* Mon May 26 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ32
- Locales updated

* Tue May 13 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ31
- Ability added to disable user owned websites.

* Sun Jan 27 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ30
- German locales added.

* Tue Jan 22 2008 Michael Stauber <mstauber@solarspeed.net> 1.1.0-79-BQ29
- Danish locales added. Thanks to Jes Klittum!

* Mon Jun 25 2007 Hisao SHIBUYA <shibuya@bluequartz.org> 1.1.0-79BQ28
- Fixed duplicate include issue.

* Fri Jul 14 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ27
- remove .backup.? file after update the package.

* Sun Mar 26 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ26
- fix typo at post script.

* Sun Mar 26 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ25
- modify preview.pl to write httpd.conf settings for comand line.

* Sun Mar 26 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ24
- execute preview.pl when update package.
- remove server.conf.

* Tue Mar 14 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ23
- to make vhosts directory at preview handler, if directory isn't exist.

* Mon Mar 13 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ22
- fix preview site function.

* Mon Mar 13 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ21
- fix vhost_addre.pl when preview settings is not exit..
- remove siteX.include after rollback.

* Sun Mar 12 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ20
- add preview site function again.

* Thu Mar 09 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ19
- remove preview site function.

* Thu Mar 09 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ18
- allow to access perview site with IP address.
- set php, cgi and ssi settings for preview site same as virtual site.

* Mon Dec 06 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ17
- modified server.pl about missing in the ModRewrite section.

* Tue Nov 29 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ16
- rebuild with devel-tools 0.5.1-0BQ7.

* Wed Nov 23 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ15
- clean up ssl_perl.conf.

* Tue Nov 15 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ14
- modifies ssl_perl.conf to fix the issue cgi doesn't work with SSL.

* Fri Nov 11 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ13
- change config name to server.conf instead of preview.conf.

* Fri Nov 11 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ12
- remove preview schemas from vsite_services that isn't needed.

* Mon Oct 31 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ11
- add preview site function.

* Tue Oct 18 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ10
- rebuild with devel-tools 0.5.1

* Fri Aug 12 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ9
- modified Group tag in rpmdefs.tmpl.

* Fri Aug 12 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ8
- add serial number.

* Thu Aug 11 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.1.0-79BQ7
- clean up spec file.
<end $CHANGELOG>
