# configuration bits for mod_rpmize
# syntax:
# <begin [x]section>
# <end [x]section>
#
# x an be $ for a string or % for a hash.
# if a hash is being used, you can add sub-sections with
# <begin sub-section>
# <end sub-section>


<begin $DESCRIPTION>
%package [LABEL]
Group: System Environment/BlueOnyx
Summary: [LABEL] for [VENDOR]-[SERVICE].
[AUTOFILL]
[BUILDARCH]
Obsoletes: solarspeed-mod_php  <= 5.2.6
Obsoletes: solarspeed-mod_php-gui <= 5.2.6

[PROVIDES]

%description [LABEL]
The [VENDOR]-[SERVICE]-[LABEL] package contains the [LABEL]
information for [VENDOR]-[SERVICE].

<end $DESCRIPTION>

<begin %PREP>
<end %PREP>

<begin %SETUP>
<end %SETUP>

<begin %BUILD>
<end %BUILD>

<begin %INSTALL>
<end %INSTALL>

<begin %FILES>
<begin HEADER>
%files [LABEL]
%defattr(-,root,root)
<end HEADER>

<begin locale>
[AUTOFILL]

<end locale>

<begin glue>
[AUTOFILL]
/etc/skel/vsite/*
%attr(0755,-,-) /usr/sausalito/sbin/vsite_destroy.pl
%attr(0755,-,-) /usr/sausalito/sbin/fix_user_suspension.pl

<end glue>

<begin ui>
[AUTOFILL]

<end ui>

<begin capstone>
%{RootDir}/capstone/%{Vendor}-%{Service}.cap
[AUTOFILL]

<end capstone>
<end %FILES>

<begin %POST-INSTALL>
<begin HEADER>
%post [LABEL]
<end HEADER>

<begin glue>
# glue post-install
if [ -S /usr/sausalito/cced.socket ]; then
    /etc/init.d/cced.init restart
fi

<end glue>
<begin ui>
# ui post-install
# this is somewhat nasty, but it always makes sure that there's a
# default .html file in case the browser doesn't specify a locale
if [ x"[DEFLOCALE]" != x ]; then
	for dir in `find [CCEWEB] -type d`; do 
		(cd $dir; 
		if [ x"`ls *.htm[l].[DEFLOCALE] 2> /dev/null`" != x ]; then
			for file in `ls *.htm[l].[DEFLOCALE]`; do
				base=`basename $file .[DEFLOCALE]`
				if [ ! -f $base ]; then
					ln -s $file $base
 				fi
			done
		fi)
	done
fi

<end ui>
<begin locale>
# locale post-install

<end locale>
<end %POST-INSTALL>

<begin %POST-UNINSTALL>
<begin HEADER>
%postun [LABEL]
<end HEADER>

<begin glue>
# glue post-uninstall

<end glue>
<begin ui>
# ui post-uninstall

<end ui>
<begin locale>
# locale post-uninstall

<end locale>
<end %POST-UNINSTALL>

<begin $CHANGELOG>

* Sun Mar 06 2011 Greg Kuhnert <taco@scargo.nl> 3.0-132BX74
- Moved the sitexx.include line after PHP gui settings to allow detailed per directory configuration settings to over-ride site level configuration (see: http://devel.blueonyx.it/trac/changeset/579 ).

* Mon Oct 31 2010 Taco Scargo <taco@scargo.nl> 3.0-132BX73
- Modified vsite.conf to fix PHP configuration bug (#295)

* Mon Jul 05 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX72
- Added field 'PHP_version' to Class 'PHP' to store version of used PHP.
- Updated constructor/import_php_ini_settings.pl to fetch that info and to store it in CODB
- Updated handlers to use the new PHP_version checks instead of platform related checks:
- Updated glue/handlers/php_handler.pl and glue/handlers/php_vsite_handler.pl
- Updated GUI pages to use the new PHP_version checks instead of platform related checks:
- Updated ui/web/fileOwner.php ui/web/vsite_phpHandler.php ui/web/vsite_php.php ui/web/php_serverHandler.php and ui/web/php_server.php

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX71
- Modified constructor/import_php_ini_settings.pl again to add a missing backslash. Doh!

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX70
- Modified constructor/import_php_ini_settings.pl again to handle uninstall of third party PHP case as well.

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX69
- Modified constructor/import_php_ini_settings.pl to detect third party PHP installs
- If detected, php-cgi location will be updated in /etc/suphp.conf

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX68
- Fixed typo in glue/handlers/php_handler.pl

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX67
- Updated glue/handlers/php_vsite_handler.pl to also chown /vhosts subdir if present.

* Sun Jul 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX66
- Shorted a locale string

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX65
- Added ui/menu/fileOwner.xml ui/web/fileOwner.php and ui/web/fileOwnerHandler.php
- They allow to select the siteAdmin that owns the site root and particularly /web of a vsite
- Extended glue/handlers/php_vsite_handler.pl to chown the siteroot and /web accordingly

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX64
- Safe_Mode related PHP settings for server and vsites needed to be removed from the GUI for PHP >= 5.3
- To retain downward compatability we now do a platform check and hide these switches on 5107R and 5108R

* Sat Jul 03 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX63
- Add RewriteCond for webAliases.

* Tue Jun 08 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX62
- Bugfixes to some PHP-5.3 related fixes. Had used the wrong replacement functions.
- Disabled 'Advanced Search' for Vsites in /base/vsite/vsiteList.php for now as it's horribly broken.

* Tue Jun 08 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX61
- PHP-5.3 related compat fixes

* Sat Jun 05 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX60
- Copied 'en locales to 'en_US'

* Fri Jun 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX59
- Plenty of PHP-5.3 related compatabiliy fixes all over the place.
- ui/web/vsite_php.php still uses POSIX style eregi_replace(), but cba to fix that now.

* Fri Jun 04 2010 Michael Stauber <mstauber@solarspeed.net> 3.0-132BX58
- Version number bump

* Sun Aug 30 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ57
- Modified glue/handlers/php_vsite_handler.pl to be more resilent about not permitting empty PHP related switches to be written to the site include files.
- Now allows to use empty open_basedir directives. In which case the config line open_basedir will simply be left out in the site include file.
- Also modified ui/web/vsite_php.php to allow empty open_basedir directives.

* Sun Aug 16 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ56
- Added ability to set PHP memory limit to valued higher than 100M.
- Also raised possible post max size upper value.
- Modified ui/web/vsite_php.php and ui/web/php_server.php

* Wed Aug 12 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ55
- When a Vsite has preview enabled, the preview was still working even if the site is suspended. Security risk!
- Bug found and reported by Steve Howes. Many thanks!
- Modified ui/web/vsiteModSave.php to set preview to disabled when a Vsite is suspended.
- Modified glue/handlers/suspend.pl to disable preview for the site when a site is suspended.

* Tue Jun 16 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ54
- Modified glue/handlers/suspend.pl to use 'usermod' to lock / unlock suspended accounts.
- This is an important security update, because without locking accounts of a suspended site those users can still use SMTP-Auth to send emails - even when the whole site is suspended.
- Added glue/sbin/fix_user_suspension.pl as command line utility to manually sync locking and unlocking of suspended users.

* Tue Jun 16 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ53
- By default we added the /home/ directory to open_basedir. This may no longer be a good idea.
- Modified glue/schemas/php.schema to remove /home/ directory from open_basedir.
- Modified glue/schemas/php_vsite.schema to remove /home/ directory from open_basedir.
- Modified constructor/import_php_ini_settings.pl to remove /home/ directory from open_basedir.

* Wed Jun 10 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ52
- During cmuImport the old paths for a sites home directory were retained for open_basedir and the new path where the site
  now resides at just got appended. This was of course highly undesireable. 
- Modified ui/web/vsite_php.php and ui/web/vsite_phpHandler.php to strip all /home/.sites/ references from open_basedir and 
  added provisions to add only the correct path to a sites home directory.
- Modified glue/handlers/php_vsite_handler.pl to do the same thing.

* Mon Apr 27 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ51
- Modified ui/web/vsite_phpHandler.php
- Was missing provisions to set allow_url_include into CCE. 

* Wed Feb 11 2009 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ50
- Modified constructor/import_php_ini_settings.pl to remove popen and escapeshellcmd from stock php.ini options for disable_functions.
- Enhanced constructor/import_php_ini_settings.pl further to remove those undesired options on CCE restart if Squirrelmail is installed.

* Mon Dec 08 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ49
- Updated ui/web/vsite_php.php. 'Safe Mode include directory' input box was 'rw' for siteAdmin. 

* Fri Dec 05 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ48
- Added obsolete tag for CentOS4 based Solarspeed PHP GUIs.

* Wed Dec 03 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ47
- Rebuilt for BlueOnyx.

* Wed Dec 03 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ46
- Modified ui/web/vsite_php.php to remove the save button when siteAdmin's view the page.
- That is somewhat hackish, as MultiChoice don't take read only switches, which would be nicer.

* Wed Dec 03 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ45
- Fixed two minor issues in ui/web/vsite_php.php and ui/web/vsite_phpHandler.php
- Added English and German locales for the PHP related additions.
- Copied new English locale strings to the Japanese and Danish locales for now until someone can translate it.

* Tue Dec 02 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ44
- Still work in progress and not yet finished.
- Added provisions to edit Apache vsite containers to insert php_admin flags, etc.
- Modified glue/conf/vsite.conf to call new glue/handlers/php_vsite_handler.pl
- Added glue/handlers/php_vsite_handler.pl to edit vhost containers.
- Added ui/web/vsite_php.php and ui/web/vsite_phpHandler.php to edit a site's PHP settings.
- Added ui/menu/vsite_php.xml to link to ui/web/vsite_php.php (under services for a site)
- Updated glue/schemas/php_vsite.schema to reflect changes
- Updated constructor/import_php_ini_settings.pl
- Removed debugging provisions from glue/handlers/php_handler.pl
- Updated ui/web/php_serverHandler.php
- Still need to do the locales for the new changes. Rest seems to work.

* Mon Dec 01 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ43
- Still work in progress and not yet finished.
- Added ability to modify max_execution_time, max_input_time and memory_limit in php.ini
- Extended glue/schemas/php.schema for that.
- Extended ui/web/php_server.php and ui/web/php_serverHandler.php for that.
- Extended constructor/import_php_ini_settings.pl and glue/handlers/php_handler.pl for that.

* Mon Dec 01 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ42
- Unfinished (!) first integration of better PHP security.
- Added constructor/import_php_ini_settings.pl to parse the php.ini and to shove its settings into CODB.
- Constructor enforces secure default settings in php.ini on first CCEd (re)start.
- Added the Schemas glue/schemas/php.schema glue/schemas/php_vsite.schema and glue/schemas/php_caps.schema for that.
- Added ui/menu/php_server.xml to show the new menu entry under "Server Management" / "Security".
- Added ui/web/php_server.php and ui/web/php_serverHandler.php to to visualize the settings and to allow changes.
- Edited glue/conf/vsite.conf to call new handlers on PHP related events.
- Added glue/handlers/php_handler.pl to update php.ini and to restart Apache if needed.
- If /etc/thirdparty_php is present, it uses the php.ini specified in that file and not /etc/php.ini
- Added requirement for perl-handler-utils >= 1.3.0-11BQ12 as our handler needs this version or newer.
- THIS CHANGES WORK, BUT ARE NOT YET FINISHED!
- Missing: UI and handlers for modifying site's PHP settings, updated locales for the new i18n strings.
- Currently disabled: Ability to edit php.ini's raw source through the GUI. Save button removed on that tab for now.

* Mon Nov 24 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ41
- Modified ui/web/manageAdmin.php to remove cracklib stuff. Cannot use it here w/o too much hassles. 
- Fixed relocation URL on errors while editing admins to point back to right page.
- Fixed editing page to show the username even on edit, but read only. Needed for username = passwd check.

* Wed Nov 19 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ40
- Modified ui/web/manageAdmin.php 
- Somehow the strcasecomp for username = password as suggested by Stephanie Sullivan never made it in here.

* Thu Nov 13 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ39
- Fixed PHP5 related display issue in ui/web/vsiteMod.php

* Wed Nov 12 2008 Michael Stauber <mstauber@solarspeed.net> 3.0-132BQ38
- Merged the following changes in from 5100R:
- fixed the version for requires sausalito-cce-server. 
- Small update in manageAdmin.php 
- Now uses strcasecmp() to check if password equals username in upper and lower case. 
- use cracklib to check password. 
- fixed the issue that siteadmin permission isn't able to be added. 
- Did NOT merge in Hisao's ui/web/manageAdmin.php as I had that already covered in 5106R.

* Sun May 18 2008 Michael Stauber <mstauber@solarspeed.net> 1.0-132BQ32
- Updated glue/handlers/network_destroy.pl

* Tue May 13 2008 Michael Stauber <mstauber@solarspeed.net> 1.0-132BQ31
- Ability added to disable user owned websites.

* Tue Feb 05 2008 Michael Stauber <mstauber@solarspeed.net> 1.0-132BQ30
- German skeleton index.html for vsite was missing.

* Sun Jan 27 2008 Michael Stauber <mstauber@solarspeed.net> 1.0-132BQ29
- German locales added.

* Tue Jan 22 2008 Michael Stauber <mstauber@solarspeed.net> 1.0-132BQ28
- Danish locales added. Thanks to Jes Klittum!

* Mon Jun 25 2007 Hisao SHIBUYA <shibuya@bluequartz.org> 1.0-132BQ27
- Fixed duplicate include issue.

* Wed Mar 07 2007 Brian N. Smith <brian@nuonce.net> 1.0-132BQ26
- Applied 'unique.pl' patch that Taco submited.  Supposed to allow
- aliases same as web alias.

* Sun Aug 13 2006 Brian N. Smith <brian@nuonce.net> 1.0-132BQ25
- Added access control for siteadmin into Disable E-Mail

* Sun Aug 06 2006 Brian N. Smith <brian@nuonce.net> 1.0-132BQ24
- For Auto DNS, host "" (empty) wasn't added.  That has been fixed.

* Sun Aug 06 2006 Brian N. Smith <brian@nuonce.net> 1.0-132BQ23
- Removed postmaster
- Removed admin

* Sat Aug 05 2006 Brian N. Smith <brian@nuonce.net> 1.0-132BQ22
- added auto-populate of email & web server aliase in vsiteAdd.php.
- Added Auto DNS Feature.  Add multiple hostnames + 1 MX record when Auto DNS is checked

* Fri Aug 04 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ21
- add disable email feature by Brian.

* Sun Jul 02 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ20
- modify Vsite.pm to add apache@FQDN into virtusertable when Vsite is added.

* Sun Mar 26 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ19
- remove post script to remove server.conf.

* Tue Mar 14 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ18
- change skelton index.html encoding to EUC-JP.

* Sun Mar 12 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ17
- add preview site function again.

* Thu Mar 09 2006 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ16
- remove preview site function.

* Sun Dec 18 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ15
- modified JavaScript to fix the browser issue with Safari by Anders, BlackSun, Inc.

* Tue Nov 29 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ14
- rebuild with devel-tools 0.5.1-0BQ7.

* Mon Oct 31 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ13
- fixed the issue that vsite isn't removed.

* Mon Oct 31 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ12
- add preview site function.

* Tue Oct 18 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ11
- rebuild with devel-tools 0.5.1

* Mon Aug 15 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ10
- modified menu order for siteName.xml.

* Mon Aug 15 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ9
- modified Group tag.

* Mon Aug 15 2005 Hisao SHIBUYA <shibuya@alpha.or.jp> 1.0-132BQ8
- fix security problem that can be accessed unauthorized function.
- clean up spec file.
<end $CHANGELOG>
